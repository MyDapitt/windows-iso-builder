name: Build Windows ISO (Windows Runner) and Upload Metadata

on:
  workflow_dispatch:
    inputs:
      archive_identifier:
        description: 'Nama item unik di Archive.org (cth: windows-11-24h2-beta)'
        required: true
        default: 'windows-11-generic-build' 

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- PERUBAHAN DI SINI ---
      - name: Download UUP files and Convert to ISO
        shell: cmd
        run: .\uup_download_windows.cmd

      # --- AKHIR PERUBAHAN ---

      - name: Upload ISO as private artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-iso
          path: "*.iso"

      - name: Generate build metadata
        id: metadata 
        shell: pwsh
        run: |
          $iso = Get-ChildItem -Filter *.iso | Select-Object -First 1
          if (-not $iso) {
            Write-Error "File ISO tidak ditemukan!"
            exit 1
          }
          $hash = Get-FileHash $iso.FullName -Algorithm SHA256
          $buildDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          $content = @"
          File Name: $($iso.Name)
          SHA256: $($hash.Hash)
          Build Date (UTC): $buildDate
          Repository: $env:GITHUB_REPOSITORY
          Run ID: $env:GITHUB_RUN_ID
          Archive Identifier: ${{ github.event.inputs.archive_identifier }}
          "@
          $content | Out-File -Encoding utf8 build-info.txt

          echo "iso_name=$($iso.Name)" >> $env:GITHUB_OUTPUT
          
      - name: Upload metadata and ISO to Archive.org
        env:
          ARCHIVE_USERNAME: ${{ secrets.ARCHIVE_USERNAME }}
          ARCHIVE_SECRET: ${{ secrets.ARCHIVE_SECRET }}
          ISO_NAME: ${{ steps.metadata.outputs.iso_name }} 
          ARCHIVE_IDENTIFIER: ${{ github.event.inputs.archive_identifier }}
        shell: pwsh
        run: |
          $auth = "${env:ARCHIVE_USERNAME}:${env:ARCHIVE_SECRET}"
          $baseUrl = "https://s3.us.archive.org/${env:ARCHIVE_IDENTIFIER}"

          Write-Host "Mengunggah ke item Archive.org: ${env:ARCHIVE_IDENTIFIER}"

          Write-Host "Mengunggah build-info.txt..."
          curl -X PUT -u $auth -T "build-info.txt" "$baseUrl/build-info.txt"

          Write-Host "Mengunggah ${{ env.ISO_NAME }}..."
          curl -X PUT -u $auth -T "${{ env.ISO_NAME }}" "$baseUrl/${{ env.ISO_NAME }}"
